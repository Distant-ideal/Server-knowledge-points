# TCP协议

## 什么是TCP

TCP（传输控制协议）是一种面向连接的，可靠的，基于字节流的传输层通信协议。在简化的计算机网络OSI模型中，它完成第四层传输层所指定的功能，用户数据报协议（UDP）是同一层内另一个重要的传输协议。在因特网协议族中，TCP层是位于IP层之上，应用层之下的中间层

应用层向TCP层发送用于网间传输的，用8位字节表示的数据流，然后TCP把数据流分区成适当长度的报文段（通常受该计算机连接的数据链路层的最大传输单元(MTU)的限制）。之后TCP把结果包传给IP层，由它来通过网络将包传送给接受端实体的TCP层。TCP为了保证不发生丢包，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接受。然后接收端实体对已成功收到的包发回一个相应的确定（ACK），如果发送端实体在合理的往返时延（RTT）内未收到确认，那么对应的数据包就被假设为已丢失将会被进行重传。TCP用一个校验和函数来检验数据是否有错误；在发送和接收时都要计算校验和。

## 三次握手

1.客户端发送SYN（SEQ=x）报文给服务器端，进入SYN_SEND状态

2.服务器端收到SYN报文，回应一个SYN（SEQ=y）ACK（ACK = x+1）报文，进去SYN_RECV状态

3.客户端收到服务器端的SYN报文，回应一个ACK（ACK=y+1）报文，进去Established状态。

三次握手完成，TCP客户端和服务器端成功地建立连接，可以开始传输数据了。

## 四次挥手

1.某个应用进程首先调用close，称该端执行“主动关闭”。该端的TCP于是发送一个FIN分节，表示数据发送完毕

2.接收到这个FIN的接收端执行“被动关闭”，这个FIN由TCP确认（FIN的接受也作为一个文件结束符传递给接收端应用进程，放在一排队等待该应用进程接受的任何其他数据之后，因为FIN的接受意味着接收端应用进程在相应连接上再无额外数据可接受）

3.一段时间后就收到这个文件结束符的应用进程将调用close关闭它的套接字，这导致它的TCP也发送一个FIN

4.接收到这个最终FIN的原发送端TCP（即执行主动关闭的那一端）确认这个份FIN

## TCP可靠性的实现逻辑

1.应用数据被分割成TCP认为最合适发送的数据块。有TCP传递给IP信息单位成为报文段或段。

2.当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文。如果不能及时收到一个确定，将重发这个报文。当TCP收到法子TCP连接另一端的数据，他将是发送一个确定。TCP有延迟确认的功能，如此功能没有打开，则立即确定。功能打开，则由定时器触发确定时间点。

3.TCP将保持它首部和数据的校验和。这是一个端到端的校验和，目的是检测数据在传输过程中的任何变化，如果收到段的检验和有差错，TCP将丢弃这个报文段和不确认收到此报文段（希望发送端超时并重发）。

4.既然TCP报文段作为IP数据报来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序，如果必要，TCP将对收到的数据进行重新排序，将收到的数据以正确的顺序交给应用层。

5.既然IP数据报会发送重复，TCP的接收端必须丢弃重复的数据。

6.TCP还能提供流量控制。TCP连接的每一方都有固定大小的缓冲空间。TCP接收端只允许另一端发送接收端缓冲区所能接纳的数据，这将防止较快主机致使较慢主机的缓冲区溢出。